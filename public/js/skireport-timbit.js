/* 
skireport-timbit.js

This file manages the dynamic changes found in the view file for the Ski Report Timbit.


This borrows from ski-report.js developed by Rob DiNardo

Written by Drew Edgar, last updated 2012-07-12
*/

jQuery(document).ready(function(){

	//Declarations
	var sr_cookie_resorts = "sr-resorts"; //cookie name
	var inString = $("#hidden_div").text();//grabs the JSON object generated by the Timbit
	var fullreport = eval ("(" + inString + ")");//eval the JSON string into a new Object
	$("#hidden_div").remove();//clean up hidden div	
	
	//Event Handlers
	jQuery("#sr_change_resort").click(showStart);	
	jQuery("#sr_dd_province").change(onChangeProvince);
	jQuery("#btndetails").click(onBtnShowResults);
	jQuery("#btnback").click(onBtnGoBack);
	jQuery("#start_over").click(showStart);

	$(".copyright").html("&copy; 2010 The Weather Network");// Sneaky way to get the © to show up
	
	//Check for Cookie
	if (readCookie(sr_cookie_resorts) != null) {
		onShowResults(readCookie(sr_cookie_resorts)); //use the results from last time
	} else {
		showStart(); //start a new search
	}
	
	function showStart() { //Start from the begining
		$("#sr_change_resort").hide(); //Hides the link that got you here
		$("#sr_results").hide(); //Hides the results section
		$("#sr_choose_prov").show(); //Show the Provice DropDown
		$("#sr_dd_province").val(1); //Resets Province DropDown to default selection
	}
	
	function onChangeProvince() { //When a Province is chosen...
		$("input").attr('checked', false); //reset all checkboxes
		$('#sr_choose_resorts').show(); //show the Checkbox list
		$('li').hide(); //Hide all of the checkboxes...
		
		if ($("#sr_dd_province").val() != "") { //... and then see what the Province selection was...
			var i = $("#sr_dd_province").val(); //... so that only the chosen Province checkboxes...
			$('.'+i).show(); //... are shown!
		}
	}
	function onBtnShowResults(){ //The 'Confirm' button for choosing the Resorts
		var arrResorts = []; //new array for storing the Resorts
		
		$('#sr_choose_resorts input:checked').each(function(){ //For each of the checkboxes that are checked...
			arrResorts.push($(this).attr("value")); //... add them to the array.
		});
		
		$('#sr_choose_resorts').hide(); //Hides the section with the Checkboxes
		onShowResults(arrResorts); //Show the results using the new choices
	}
	
	function onBtnGoBack(){ //Cancelling selection
		onShowResults(readCookie(sr_cookie_resorts)); //Show the results of the choices from 'last time'
	}
	
	function onShowResults(arrResorts) { //Show the details for the desired Ski Resorts
		var inputHtml = "";
		
		$("#sr_change_resort").show(); //Show the link to start over
		$("#sr_choose_prov").hide(); //hide the section for choosing the Province
		$("#sr_choose_resorts").hide(); //Hide the checkbox list
		$('#sr_results').show(); //Show the results Panel
		
		 //Cookie stores selections with Comma Seperated Values
		 //This filters it out and converts it to an array
		if (arrResorts.indexOf(",") != -1) //If a comma exists in the selection
		{
			arrResorts = arrResorts.split(','); //Split into an Array on the Comma(s)
		}
		
		//String construction for outputting Report details
		inputHtml = "<div class='province'>";
		$.each(arrResorts, function(key, value){//For each of the chosen Resorts
			
			$.each(fullreport['SITE'], function(){ //For each of the 'SITE' instances in the Object
				if(this['@']['LOCATIONID'] == value){ //Check if the 'SITE' is one of the selected Resorts
					inputHtml += "<table border=0><tbody><tr>";
					inputHtml += "<td class='left'>" + this['@']['NAME_EN'] + " &raquo;</td>";
					inputHtml += "<td class='right'>" + this['@']['PROV'] + "</td>";
					inputHtml += "</tr></tbody></table>";
					
					inputHtml += "<table class='ski_report_table' border=0><tbody>";
					inputHtml += "<tr>";
					inputHtml += "<td class='first_td'>Conditions</td>";
					inputHtml += "<td class='second_td'>"+ this['DATA']['@']['SKICONDITION1_EN'] + "</td>";
					inputHtml += "</tr><tr>"
					inputHtml += "<td class='first_td'>Base</td>";
					inputHtml += "<td class='second_td'>"+ this['DATA']['@']['SNOWDEPTH'] + " cm</td>";
					inputHtml += "</tr><tr>"
					var runPercent = Math.round((this['DATA']['@']['NUMBERRUNSOPEN'] / this['DATA']['@']['NUMBERRUNSTOTAL']) * 100);
					inputHtml += "<td class='first_td'>Runs</td>";
					inputHtml += "<td class='second_td'>"+ this['DATA']['@']['NUMBERRUNSOPEN'] + " of " + this['DATA']['@']['NUMBERRUNSTOTAL'] + " - <span>" + runPercent + "%</span></td>";
					inputHtml += "</tr><tr>"
					var liftPercent = Math.round((this['DATA']['@']['LIFTSOPEN'] / this['DATA']['@']['LIFTSTOTAL']) * 100);
					inputHtml += "<td class='first_td'>Lifts</td>";
					inputHtml += "<td class='second_td'>"+ this['DATA']['@']['LIFTSOPEN'] + " of " + this['DATA']['@']['LIFTSTOTAL'] + " - <span>" + liftPercent + "%</span></td>";
					inputHtml += "</tr><tr>"
					inputHtml += "<td class='first_td'>Report Date</td>";
					inputHtml += "<td class='second_td'>"+ this['DATA']['@']['REPORTDATE'] + "</td>";
					inputHtml += "</tr></tbody></table>";
				}
			});
		});inputHtml += "</div>";
		
		$('#sr_results').html(inputHtml); //Place the generated HTML on the page
		eraseCookie(sr_cookie_resorts); //Clear the cookie from 'last time'
		
		createCookie(sr_cookie_resorts,arrResorts,15); //Make a new cookie with the current selections
	}
	
});

//The following was directly taken from Rob DiNardo's ski-report.js 
//file for the orignal LEGO Widget: Ski Report
function createCookie(name,value,days) {
	if (days) {
		var date = new Date();
		date.setTime(date.getTime()+(days*24*60*60*1000));
		var expires = "; expires="+date.toGMTString();
	}
	else var expires = "";
	document.cookie = name+"="+value+expires+"; path=/";
}

function readCookie(name) {
	var nameEQ = name + "=";
	var ca = document.cookie.split(';');
	for(var i=0;i < ca.length;i++) {
		var c = ca[i];
		while (c.charAt(0)==' ') c = c.substring(1,c.length);
		if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
	}
	return null;
}

function eraseCookie(name) {
	createCookie(name,"",-1);
}